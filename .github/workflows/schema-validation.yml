name: Schema Validation

on:
  pull_request:
    branches: [ main, staging ]

jobs:
  schema-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          npm ci

      - name: Run schema probe
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          node scripts/schema-probe.js

      - name: Generate adaptive tests and migrations
        run: |
          node scripts/generate-adaptive-tests.js
          node scripts/generate-migrations.js

      - name: Check critical schema
        run: |
          node scripts/check-schema-critical.js

      - name: Validate RLS policies
        run: |
          node scripts/validate-rls.js

      - name: Run adaptive payment E2E (staging)
        env:
          SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.STAGING_SUPABASE_SERVICE_ROLE_KEY }}
          RAZORPAY_WEBHOOK_SECRET: ${{ secrets.STAGING_RAZORPAY_WEBHOOK_SECRET }}
          WEBHOOK_URL: ${{ secrets.STAGING_WEBHOOK_URL }}
        run: |
          NODE_OPTIONS=--experimental-fetch npm run test:payments:e2e

      - name: Create suggested-migrations PR
        if: ${{ success() && steps.generate_outputs }}
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(schema): suggested migration SQL from schema-probe"
          branch: "suggested/schema-migrations-${{ github.sha }}"
          title: "Suggested schema migrations (automated)"
          body: "This PR contains suggested SQL migrations generated by the schema probe. Review before applying."
          paths: |
            scripts/generated/suggested-migrations.sql

      - name: Notify Slack (optional)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  apply-to-staging:
    if: github.event_name == 'push' && contains(github.ref, 'refs/heads/main')
    runs-on: ubuntu-latest
    needs: schema-validation
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run migrations on staging
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          # dry-run first
          node scripts/run-migrations.js --dry-run || true
          # apply migrations to staging
          node scripts/run-migrations.js --yes || exit 1

      - name: Health check staging
        env:
          HEALTH_URL: ${{ secrets.STAGING_HEALTH_URL }}
        run: |
          STATUS=$(curl -sS -o /dev/null -w "%{http_code}" "$HEALTH_URL")
          if [ "$STATUS" != "200" ]; then echo "Staging health check failed: $STATUS"; exit 2; fi
